<?php

namespace App\Http\Controllers\Web;

use App\Http\Controllers\Controller;
use App\Models\Consumable;
use App\Models\NonConsumable;
use App\Models\Request as SupplyRequest;
use App\Models\User;
use App\Models\Log;
use App\Models\Category;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Schema;
use Barryvdh\DomPDF\Facade\Pdf;
use Carbon\Carbon;

class ReportsController extends Controller
{
    /**
     * Check if status column exists (MySQL 5.5 compatible)
     * Cache the result to avoid repeated queries
     */
    private function hasWorkflowColumn()
    {
        static $hasColumn = null;
        
        if ($hasColumn === null) {
            try {
                // Use a simple query that works with MySQL 5.5
                $result = DB::select("SHOW COLUMNS FROM requests LIKE 'status'");
                $hasColumn = count($result) > 0;
            } catch (\Exception $e) {
                // If there's any error, assume column doesn't exist
                $hasColumn = false;
            }
        }
        
        return $hasColumn;
    }

    /**
     * Get appropriate status query based on available columns
     */
    private function getRequestsByStatus($query, $status)
    {
        switch ($status) {
            case 'pending':
                return $query->where('status', 'pending');
            case 'fulfilled':
                return $query->where('status', 'fulfilled');
            case 'approved':
                return $query->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed']);
            case 'declined':
                return $query->where('status', 'declined');
            default:
                return $query;
        }
    }

    public function index(Request $request)
    {
        // Handle period parameter for dashboard functionality
        $period = $request->get('period', 'daily');

        // Check if status column exists
        if (!$this->hasWorkflowColumn()) {
            $data = [
                'total_requests' => 0,
                'completed_requests' => 0,
                'pending_requests' => 0,
                'items_requested' => 0,
                'chart_data' => [],
            ];
            $message = 'Dashboard temporarily unavailable while database is being updated.';
        } else {
            $data = $this->getReportData($period);
            $message = null;
        }

        // Add unique users count to data
        $dateRange = $this->getDateRangeFromPeriod($period);
        $data['unique_users'] = SupplyRequest::whereBetween('created_at', [$dateRange['from'], $dateRange['to']])
            ->distinct('user_id')
            ->count('user_id');

        // Get basic stats for the stats cards
        $stats = [
            'total_items' => \App\Models\Consumable::count() + \App\Models\NonConsumable::count(),
            'low_stock_items' => \App\Models\Consumable::whereRaw('quantity <= min_stock')->count() + \App\Models\NonConsumable::whereRaw('quantity <= min_stock')->count(),
            'total_requests_this_month' => SupplyRequest::whereMonth('created_at', Carbon::now()->month)->count(),
            'pending_requests' => $this->getRequestsByStatus(SupplyRequest::query(), 'pending')->count(),
            'categories_count' => Category::count(),
        ];

        return view('admin.reports.index', compact('stats', 'data', 'period', 'message'));
    }

    /**
     * Get report data based on period
     */
    private function getReportData($period)
    {
        $now = Carbon::now();
        
        switch ($period) {
            case 'daily':
                return $this->getDailyReportData($now);
            case 'weekly': 
                return $this->getWeeklyReportData($now);
            case 'monthly':
                return $this->getMonthlyReportData($now);
            case 'quarterly':
                return $this->getQuarterlyReportData($now);
            case 'annually':
                return $this->getAnnualReportData($now);
            default:
                return $this->getMonthlyReportData($now);
        }
    }

    private function getDailyReportData($date)
    {
        $startDate = $date->copy()->startOfDay();
        $endDate = $date->copy()->endOfDay();
        
        // Get last 7 days for chart - use single query with date grouping
        $chartData = [];
        
        // Get all requests for the last 7 days in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(requests.created_at) as date, COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$date->copy()->subDays(6)->startOfDay(), $endDate])
            ->groupByRaw('DATE(requests.created_at)')
            ->orderByRaw('DATE(requests.created_at)');
        
        $requestsData = $requestsQuery->get()->keyBy('date');
        
        // Build chart data for last 7 days
        for ($i = 6; $i >= 0; $i--) {
            $checkDate = $date->copy()->subDays($i);
            $dateKey = $checkDate->format('Y-m-d');
            
            $data = $requestsData->get($dateKey);
            
            $chartData[] = [
                'date' => $checkDate->format('M j'),
                'requests' => $data ? (int)$data->total_requests : 0,
                'disbursements' => $data ? (int)$data->fulfilled_requests : 0,
                'value' => $data ? (float)$data->total_value : 0
            ];
        }
        
        // Today's data - get all records for display
        $todayRequests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->get();
        
        // Calculate today's summary using the same efficient query
        $todaySummary = SupplyRequest::selectRaw('COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, SUM(CASE WHEN status IN ("pending") THEN 1 ELSE 0 END) as pending_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$startDate, $endDate]);
        
        $summaryData = $todaySummary->first();
        
        return [
            'period' => 'Daily',
            'current_date' => $date->format('F j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => (int)($summaryData->total_requests ?? 0),
                'fulfilled_requests' => (int)($summaryData->fulfilled_requests ?? 0),
                'pending_requests' => (int)($summaryData->pending_requests ?? 0),
                'total_value' => (float)($summaryData->total_value ?? 0),
            ],
            'records' => $todayRequests
        ];
    }

    private function getWeeklyReportData($date)
    {
        $startDate = $date->copy()->startOfWeek();
        $endDate = $date->copy()->endOfWeek();
        
        // Get all requests for the last 8 weeks in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(requests.created_at) as date, COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$date->copy()->subWeeks(7)->startOfWeek(), $endDate])
            ->groupByRaw('DATE(requests.created_at)')
            ->orderByRaw('DATE(requests.created_at)');
        
        $requestsData = $requestsQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y-W') . sprintf('%02d', $date->weekOfYear);
        });
        
        // Build chart data for last 8 weeks
        $chartData = [];
        for ($i = 7; $i >= 0; $i--) {
            $weekStart = $date->copy()->subWeeks($i)->startOfWeek();
            $weekKey = $weekStart->format('Y-W') . sprintf('%02d', $weekStart->weekOfYear);
            
            $weekData = $requestsData->get($weekKey, collect());
            $totalRequests = $weekData->sum('total_requests');
            $fulfilledRequests = $weekData->sum('fulfilled_requests');
            $totalValue = $weekData->sum('total_value');
            
            $chartData[] = [
                'date' => $weekStart->format('M j') . ' - ' . $weekStart->copy()->endOfWeek()->format('M j'),
                'requests' => (int)$totalRequests,
                'disbursements' => (int)$fulfilledRequests,
                'value' => (float)$totalValue
            ];
        }
        
        // Current week requests for display
        $weekRequests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->get();
        
        // Calculate current week summary
        $weekSummary = SupplyRequest::selectRaw('COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, SUM(CASE WHEN status = "pending" THEN 1 ELSE 0 END) as pending_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$startDate, $endDate]);
        
        $summaryData = $weekSummary->first();
        
        return [
            'period' => 'Weekly',
            'current_date' => $startDate->format('M j') . ' - ' . $endDate->format('M j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => (int)($summaryData->total_requests ?? 0),
                'fulfilled_requests' => (int)($summaryData->fulfilled_requests ?? 0),
                'pending_requests' => (int)($summaryData->pending_requests ?? 0),
                'total_value' => (float)($summaryData->total_value ?? 0),
            ],
            'records' => $weekRequests
        ];
    }

    private function getMonthlyReportData($date)
    {
        $startDate = $date->copy()->startOfMonth();
        $endDate = $date->copy()->endOfMonth();
        
        // Get last 12 months for chart
        $chartData = [];
        for ($i = 11; $i >= 0; $i--) {
            $monthStart = $date->copy()->subMonths($i)->startOfMonth();
            $monthEnd = $date->copy()->subMonths($i)->endOfMonth();
            
            $chartData[] = [
                'date' => $monthStart->format('M Y'),
                'requests' => SupplyRequest::whereBetween('created_at', [$monthStart, $monthEnd])->count(),
                'disbursements' => SupplyRequest::whereBetween('created_at', [$monthStart, $monthEnd])
                    ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
                'value' => SupplyRequest::whereBetween('created_at', [$monthStart, $monthEnd])
                    ->with('item')->get()->sum(function($req) {
                        return $req->quantity * ($req->item->unit_price ?? 0);
                    })
            ];
        }
        
        $monthRequests = SupplyRequest::whereBetween('created_at', [$startDate, $endDate])->get();
        
        return [
            'period' => 'Monthly',
            'current_date' => $startDate->format('F Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $monthRequests->count(),
                'fulfilled_requests' => $monthRequests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
                'pending_requests' => $monthRequests->where('status', 'pending')->count(),
                'total_value' => $monthRequests->sum(function($req) {
                    return $req->quantity * ($req->item->unit_price ?? 0);
                }),
            ],
            'records' => $monthRequests->load(['user', 'item', 'item.category'])
        ];
    }

    private function getQuarterlyReportData($date)
    {
        $startDate = $date->copy()->startOfQuarter();
        $endDate = $date->copy()->endOfQuarter();
        
        // Get last 4 quarters for chart
        $chartData = [];
        for ($i = 3; $i >= 0; $i--) {
            $quarterStart = $date->copy()->subQuarters($i)->startOfQuarter();
            $quarterEnd = $date->copy()->subQuarters($i)->endOfQuarter();
            
            $chartData[] = [
                'date' => 'Q' . $quarterStart->quarter . ' ' . $quarterStart->year,
                'requests' => SupplyRequest::whereBetween('created_at', [$quarterStart, $quarterEnd])->count(),
                'disbursements' => SupplyRequest::whereBetween('created_at', [$quarterStart, $quarterEnd])
                    ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
                'value' => SupplyRequest::whereBetween('created_at', [$quarterStart, $quarterEnd])
                    ->with('item')->get()->sum(function($req) {
                        return $req->quantity * ($req->item->unit_price ?? 0);
                    })
            ];
        }
        
        $quarterRequests = SupplyRequest::whereBetween('created_at', [$startDate, $endDate])->get();
        
        return [
            'period' => 'Quarterly',
            'current_date' => 'Q' . $startDate->quarter . ' ' . $startDate->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $quarterRequests->count(),
                'fulfilled_requests' => $quarterRequests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
                'pending_requests' => $quarterRequests->where('status', 'pending')->count(),
                'total_value' => $quarterRequests->sum(function($req) {
                    return $req->quantity * ($req->item->unit_price ?? 0);
                }),
            ],
            'records' => $quarterRequests->load(['user', 'item', 'item.category'])
        ];
    }

    private function getAnnualReportData($date)
    {
        $startDate = $date->copy()->startOfYear();
        $endDate = $date->copy()->endOfYear();
        
        // Get all requests for the last 5 years in one query
        $requestsQuery = SupplyRequest::selectRaw('YEAR(requests.created_at) as year, COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$date->copy()->subYears(4)->startOfYear(), $endDate])
            ->groupByRaw('YEAR(requests.created_at)')
            ->orderByRaw('YEAR(requests.created_at)');
        
        $requestsData = $requestsQuery->get()->keyBy('year');
        
        // Build chart data for last 5 years
        $chartData = [];
        for ($i = 4; $i >= 0; $i--) {
            $year = $date->copy()->subYears($i)->year;
            
            $data = $requestsData->get($year);
            
            $chartData[] = [
                'date' => (string)$year,
                'requests' => $data ? (int)$data->total_requests : 0,
                'disbursements' => $data ? (int)$data->fulfilled_requests : 0,
                'value' => $data ? (float)$data->total_value : 0
            ];
        }
        
        // Current year requests for display
        $yearRequests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->get();
        
        // Calculate current year summary
        $yearSummary = SupplyRequest::selectRaw('COUNT(*) as total_requests, SUM(CASE WHEN status IN ("approved_by_admin", "fulfilled", "claimed") THEN 1 ELSE 0 END) as fulfilled_requests, SUM(CASE WHEN status = "pending" THEN 1 ELSE 0 END) as pending_requests, 0 as total_value')
            ->whereBetween('requests.created_at', [$startDate, $endDate]);
        
        $summaryData = $yearSummary->first();
        
        return [
            'period' => 'Annual',
            'current_date' => (string)$date->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => (int)($summaryData->total_requests ?? 0),
                'fulfilled_requests' => (int)($summaryData->fulfilled_requests ?? 0),
                'pending_requests' => (int)($summaryData->pending_requests ?? 0),
                'total_value' => (float)($summaryData->total_value ?? 0),
            ],
            'records' => $yearRequests
        ];
    }

    public function inventorySummary(Request $request)
    {
        $query = Item::with('category');

        // Apply filters
        if ($request->category_id) {
            $query->where('category_id', $request->category_id);
        }

        if ($request->stock_status) {
            switch ($request->stock_status) {
                case 'low_stock':
                    $query->whereRaw('current_stock <= minimum_stock');
                    break;
                case 'out_of_stock':
                    $query->where('current_stock', '<=', 0);
                    break;
                case 'adequate':
                    $query->where('current_stock', '>', 'minimum_stock');
                    break;
            }
        }

        // Apply sorting
        $sortBy = $request->get('sort_by', 'name');
        switch ($sortBy) {
            case 'quantity':
                $query->orderBy('current_stock', 'desc');
                break;
            case 'category':
                $query->join('categories', 'items.category_id', '=', 'categories.id')
                      ->orderBy('categories.name')
                      ->select('items.*');
                break;
            default:
                $query->orderBy('name');
        }

        // Paginate results
        $items = $query->paginate(25);

        // Get all categories for filter dropdown
        $categories = Category::all();

        // Calculate summary statistics
        $allItems = Item::all(); // Get all items for summary stats
        $summary = [
            'total_items' => $allItems->count(),
            'low_stock_items' => $allItems->where('current_stock', '<=', 'minimum_stock')->count(),
            'out_of_stock_items' => $allItems->where('current_stock', '<=', 0)->count(),
            'adequate_stock_items' => $allItems->where('current_stock', '>', 'minimum_stock')->count(),
        ];

        // Category statistics for chart
        $categoryStats = Category::with('items')->get()->map(function($category) {
            return [
                'name' => $category->name,
                'items_count' => $category->items->count(),
            ];
        })->filter(function($category) {
            return $category['items_count'] > 0;
        });

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.inventory-summary', compact('items', 'summary', 'request'))
                ->setPaper('a4', 'landscape');

            return $pdf->download('inventory-summary-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.inventory-summary', compact('items', 'categories', 'summary', 'categoryStats'));
    }

    public function lowStockAlert(Request $request)
    {
        $query = Item::with('category')
            ->whereRaw('current_stock <= minimum_stock OR current_stock <= 5');

        if ($request->category_id) {
            $query->where('category_id', $request->category_id);
        }

        $lowStockItems = $query->orderBy('current_stock', 'asc')->get();
        $categories = Category::all();

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.low-stock-alert', compact('lowStockItems'));
            return $pdf->download('low-stock-alert-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.low-stock-alert', compact('lowStockItems', 'categories'));
    }

    public function requestAnalytics(Request $request)
    {
        // Handle period parameter for consistent filtering with main reports
        $period = $request->get('period', 'daily');

        // Get report data based on period
        $data = $this->getRequestAnalyticsReportData($period);

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.request-analytics', compact('data'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('request-analytics-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.request-analytics', compact('data', 'period'));
    }

    public function userActivityReport(Request $request)
    {
        // Handle period parameter for consistent filtering with main reports
        $period = $request->get('period', 'daily');

        // Get date range based on period
        $dateRange = $this->getDateRangeFromPeriod($period);
        $dateFrom = $dateRange['from'];
        $dateTo = $dateRange['to'];

        $logs = Log::with('user')
            ->whereBetween('created_at', [$dateFrom, $dateTo])
            ->orderBy('created_at', 'desc')
            ->get();

        $activityStats = [
            'total_activities' => $logs->count(),
            'unique_users' => $logs->pluck('user_id')->unique()->count(),
            'activities_by_action' => $logs->groupBy('action')->map->count(),
            'most_active_users' => $logs->groupBy('user_id')->map(function($userLogs) {
                return [
                    'user' => $userLogs->first()->user,
                    'activity_count' => $userLogs->count(),
                    'last_activity' => $userLogs->first()->created_at
                ];
            })->sortByDesc('activity_count')->take(10),
            'daily_activity' => $logs->groupBy(function($log) {
                return Carbon::parse($log->created_at)->format('Y-m-d');
            })->map->count(),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.user-activity', compact('logs', 'activityStats', 'dateFrom', 'dateTo'));
            return $pdf->download('user-activity-report-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.user-activity', compact('logs', 'activityStats', 'dateFrom', 'dateTo', 'period'));
    }

    /**
     * QR Code Scan Analytics Report
     */
    public function qrScanAnalytics(Request $request)
    {
        // Handle period parameter for consistent filtering with main reports
        $period = $request->get('period', 'daily');

        // Get report data based on period
        $data = $this->getQrScanReportData($period);

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.qr-scan-analytics', compact('data'))
                ->setPaper('a4', 'landscape');

            return $pdf->download('qr-scan-analytics-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.qr-scan-analytics', compact('data', 'period'));
    }

    /**
     * QR Code Scan History for Specific Item
     */
    public function itemScanHistory(Request $request, $itemId)
    {
        $item = Item::findOrFail($itemId);

        // Handle period parameter for consistent filtering with main reports
        $period = $request->get('period', 'daily');

        // Get date range based on period
        $dateRange = $this->getDateRangeFromPeriod($period);
        $dateFrom = $dateRange['from'];
        $dateTo = $dateRange['to'];

        $scanLogs = \App\Models\ItemScanLog::with('user')
            ->where('item_id', $itemId)
            ->whereBetween('scanned_at', [$dateFrom, $dateTo])
            ->orderBy('scanned_at', 'desc')
            ->get();

        $frequencyAnalysis = \App\Models\ItemScanLog::getScanFrequencyAnalysis($itemId);

        $analytics = [
            'total_scans' => $scanLogs->count(),
            'first_scan' => $scanLogs->isNotEmpty() ? $scanLogs->last()->scanned_at : null,
            'last_scan' => $scanLogs->isNotEmpty() ? $scanLogs->first()->scanned_at : null,
            'unique_users' => $scanLogs->pluck('user_id')->unique()->filter()->count(),
            'scans_by_location' => $scanLogs->whereNotNull('location')
                ->groupBy('location')
                ->map->count(),
            'frequency_analysis' => $frequencyAnalysis,
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.item-scan-history', compact('item', 'scanLogs', 'analytics', 'dateFrom', 'dateTo'))
                ->setPaper('a4', 'landscape');

            return $pdf->download('item-scan-history-' . $item->id . '-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.item-scan-history', compact('item', 'scanLogs', 'analytics', 'dateFrom', 'dateTo', 'period'));
    }

    /**
     * QR Code Scan Alerts Report
     */
    public function scanAlerts(Request $request)
    {
        $alerts = \App\Models\ItemScanLog::getScanAlerts();

        $unscannedItems = [
            '30_days' => \App\Models\ItemScanLog::getUnscannedItems(30),
            '60_days' => \App\Models\ItemScanLog::getUnscannedItems(60),
            '90_days' => \App\Models\ItemScanLog::getUnscannedItems(90),
        ];

        $stats = [
            'total_alerts' => count($alerts),
            'unscanned_30_days' => $unscannedItems['30_days']->count(),
            'unscanned_60_days' => $unscannedItems['60_days']->count(),
            'unscanned_90_days' => $unscannedItems['90_days']->count(),
            'unusual_activity_count' => isset($alerts['unusual_scan_activity']) ? $alerts['unusual_scan_activity']->count() : 0,
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.scan-alerts', compact('alerts', 'unscannedItems', 'stats'))
                ->setPaper('a4', 'landscape');

            return $pdf->download('scan-alerts-' . date('Y-m-d') . '.pdf');
        }

        return view('admin.reports.scan-alerts', compact('alerts', 'unscannedItems', 'stats'));
    }

    // Helper methods for analytics calculations
    private function calculateAverageProcessingTime($requests)
    {
        $processedRequests = $requests->filter(function($request) {
            return $request->admin_approval_date && $request->created_at;
        });

        if ($processedRequests->isEmpty()) {
            return 0;
        }

        $totalProcessingTime = $processedRequests->sum(function($request) {
            return Carbon::parse($request->admin_approval_date)
                ->diffInHours(Carbon::parse($request->created_at));
        });

        return round($totalProcessingTime / $processedRequests->count(), 2);
    }

    private function getMostRequestedItems($requests)
    {
        return $requests->groupBy('item_id')
            ->map(function($itemRequests) {
                return [
                    'item' => $itemRequests->first()->item,
                    'total_quantity' => $itemRequests->sum('quantity'),
                    'request_count' => $itemRequests->count()
                ];
            })
            ->sortByDesc('total_quantity')
            ->take(10);
    }

    private function getRequestsByDepartment($requests)
    {
        return $requests->groupBy('department')->map->count();
    }

    private function getRequestsByPriority($requests)
    {
        return $requests->groupBy('priority')->map->count();
    }

    private function getMonthlyTrend($dateFrom, $dateTo)
    {
        $start = Carbon::parse($dateFrom);
        $end = Carbon::parse($dateTo);
        $trend = [];

        while ($start <= $end) {
            $monthStart = $start->copy()->startOfMonth();
            $monthEnd = $start->copy()->endOfMonth();

            $trend[$start->format('Y-m')] = SupplyRequest::whereBetween('created_at', [$monthStart, $monthEnd])->count();
            
            $start->addMonth();
        }

        return $trend;
    }

    /**
     * Daily transactions report
     */
    public function dailyTransactions(Request $request)
    {
        $date = $request->date ?? Carbon::today()->toDateString();
        
        $transactions = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereDate('created_at', $date)
            ->orderBy('created_at', 'desc')
            ->get();

        $stats = [
            'total_requests' => $transactions->count(),
            'approved_today' => $transactions->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_today' => $transactions->where('status', 'pending')->count(),
            'total_value' => $transactions->sum(function($req) {
                return $req->quantity * 0; // unit_price not available in normalized tables
            }),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.daily-transactions', compact('transactions', 'stats', 'date'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('daily-transactions-' . $date . '.pdf');
        }

        return view('admin.reports.daily-transactions', compact('transactions', 'stats', 'date'));
    }

    /**
     * Daily disbursement report
     */
    public function dailyDisbursement(Request $request)
    {
        $date = $request->date ?? Carbon::today()->toDateString();
        
        $disbursements = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereDate('updated_at', $date)
            ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })
            ->orderBy('updated_at', 'desc')
            ->get();

        $stats = [
            'total_disbursed' => $disbursements->count(),
            'total_value' => $disbursements->sum(function($req) {
                return $req->quantity * 0; // unit_price not available in normalized tables
            }),
            'total_quantity' => $disbursements->sum('quantity'),
            'unique_items' => $disbursements->pluck('item_id')->unique()->count(),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.daily-disbursement', compact('disbursements', 'stats', 'date'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('daily-disbursement-' . $date . '.pdf');
        }

        return view('admin.reports.daily-disbursement', compact('disbursements', 'stats', 'date'));
    }

    /**
     * Weekly summary report
     */
    public function weeklySummary(Request $request)
    {
        $startDate = $request->start_date ?? Carbon::now()->startOfWeek()->toDateString();
        $endDate = $request->end_date ?? Carbon::now()->endOfWeek()->toDateString();
        
        $weeklyData = [
            'requests' => SupplyRequest::with(['user', 'item', 'item.category'])
                ->whereBetween('created_at', [$startDate, $endDate])
                ->get(),
            'disbursements' => SupplyRequest::with(['user', 'item', 'item.category'])
                ->whereBetween('updated_at', [$startDate, $endDate])
                ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })
                ->get(),
            'new_items' => Item::with('category')
                ->whereBetween('created_at', [$startDate, $endDate])
                ->get(),
        ];

        $stats = [
            'total_requests' => $weeklyData['requests']->count(),
            'total_disbursements' => $weeklyData['disbursements']->count(),
            'new_items_added' => $weeklyData['new_items']->count(),
            'total_request_value' => $weeklyData['requests']->sum(function($req) {
                return $req->quantity * 0; // unit_price not available in normalized tables
            }),
            'daily_breakdown' => $this->getWeeklyBreakdown($startDate, $endDate),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.weekly-summary', compact('weeklyData', 'stats', 'startDate', 'endDate'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('weekly-summary-' . $startDate . '-to-' . $endDate . '.pdf');
        }

        return view('admin.reports.weekly-summary', compact('weeklyData', 'stats', 'startDate', 'endDate'));
    }

    /**
     * Weekly requests report
     */
    public function weeklyRequests(Request $request)
    {
        $startDate = $request->start_date ?? Carbon::now()->startOfWeek()->toDateString();
        $endDate = $request->end_date ?? Carbon::now()->endOfWeek()->toDateString();
        
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        $analytics = [
            'total_requests' => $requests->count(),
            'by_department' => $requests->groupBy('department')->map->count(),
            'by_status' => $requests->groupBy('status')->map->count(),
            'by_priority' => $requests->groupBy('priority')->map->count(),
            'most_requested' => $this->getMostRequestedItems($requests),
            'daily_trend' => $this->getDailyTrend($startDate, $endDate),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.weekly-requests', compact('requests', 'analytics', 'startDate', 'endDate'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('weekly-requests-' . $startDate . '-to-' . $endDate . '.pdf');
        }

        return view('admin.reports.weekly-requests', compact('requests', 'analytics', 'startDate', 'endDate'));
    }

    /**
     * Monthly summary report
     */
    public function monthlySummary(Request $request)
    {
        $month = $request->month ?? Carbon::now()->format('Y-m');
        $startDate = Carbon::createFromFormat('Y-m', $month)->startOfMonth();
        $endDate = Carbon::createFromFormat('Y-m', $month)->endOfMonth();
        
        $monthlyData = [
            'requests' => SupplyRequest::with(['user', 'item', 'item.category'])
                ->whereBetween('created_at', [$startDate, $endDate])
                ->get(),
            'inventory_changes' => collect([
                ...Consumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
                ...NonConsumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
            ]),
            'low_stock_items' => collect([
                ...Consumable::with('category')->whereRaw('quantity <= min_stock')->get(),
                ...NonConsumable::with('category')->whereRaw('quantity <= min_stock')->get(),
            ]),
        ];

        $analytics = [
            'total_requests' => $monthlyData['requests']->count(),
            'approved_requests' => $monthlyData['requests']->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'monthly_value' => $monthlyData['requests']->sum(function($req) {
                return $req->quantity * 0; // unit_price not available in normalized tables
            }),
            'weekly_breakdown' => $this->getMonthlyWeeklyBreakdown($startDate, $endDate),
            'department_performance' => $this->getDepartmentPerformance($monthlyData['requests']),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.monthly-summary', compact('monthlyData', 'analytics', 'month', 'startDate', 'endDate'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('monthly-summary-' . $month . '.pdf');
        }

        return view('admin.reports.monthly-summary', compact('monthlyData', 'analytics', 'month', 'startDate', 'endDate'));
    }

    /**
     * Quarterly summary report
     */
    public function quarterlySummary(Request $request)
    {
        $quarter = $request->quarter ?? Carbon::now()->format('Y-Q');
        $year = explode('-', $quarter)[0];
        $quarterNum = explode('-', $quarter)[1];
        
        $startDate = Carbon::createFromDate($year, ($quarterNum - 1) * 3 + 1, 1)->startOfQuarter();
        $endDate = Carbon::createFromDate($year, ($quarterNum - 1) * 3 + 1, 1)->endOfQuarter();
        
        $quarterlyData = [
            'requests' => SupplyRequest::with(['user', 'item', 'item.category'])
                ->whereBetween('created_at', [$startDate, $endDate])
                ->get(),
            'inventory_changes' => collect([
                ...Consumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
                ...NonConsumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
            ]),
            'low_stock_items' => collect([
                ...Consumable::with('category')->whereRaw('quantity <= min_stock')->get(),
                ...NonConsumable::with('category')->whereRaw('quantity <= min_stock')->get(),
            ]),
        ];

        $analytics = [
            'total_requests' => $quarterlyData['requests']->count(),
            'approved_requests' => $quarterlyData['requests']->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'monthly_breakdown' => $this->getQuarterlyMonthlyBreakdown($startDate, $endDate),
            'department_performance' => $this->getDepartmentPerformance($quarterlyData['requests']),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.quarterly-summary', compact('quarterlyData', 'analytics', 'quarter', 'startDate', 'endDate'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('quarterly-summary-' . $quarter . '.pdf');
        }

    /**
     * Annual summary report
     */
    public function annualSummary(Request $request)
    {
        $year = $request->year ?? Carbon::now()->year;
        $startDate = Carbon::createFromDate($year, 1, 1)->startOfYear();
        $endDate = Carbon::createFromDate($year, 12, 31)->endOfYear();
        
        $annualData = [
            'requests' => SupplyRequest::with(['user', 'item', 'item.category'])
                ->whereBetween('created_at', [$startDate, $endDate])
                ->get(),
            'inventory_changes' => collect([
                ...Consumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
                ...NonConsumable::with('category')->whereBetween('updated_at', [$startDate, $endDate])->get(),
            ]),
            'low_stock_items' => collect([
                ...Consumable::with('category')->whereRaw('quantity <= min_stock')->get(),
                ...NonConsumable::with('category')->whereRaw('quantity <= min_stock')->get(),
            ]),
        ];

        $analytics = [
            'total_requests' => $annualData['requests']->count(),
            'approved_requests' => $annualData['requests']->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'quarterly_breakdown' => $this->getAnnualQuarterlyBreakdown($year),
            'department_performance' => $this->getDepartmentPerformance($annualData['requests']),
        ];

        if ($request->input('format') === 'pdf') {
            $pdf = Pdf::loadView('admin.reports.pdf.annual-summary', compact('annualData', 'analytics', 'year', 'startDate', 'endDate'))
                ->setPaper('a4', 'landscape');
            
            return $pdf->download('annual-summary-' . $year . '.pdf');
        }

        return view('admin.reports.annual-summary', compact('annualData', 'analytics', 'year', 'startDate', 'endDate'));
    }
    private function getWeeklyBreakdown($startDate, $endDate)
    {
        $breakdown = [];
        $current = Carbon::parse($startDate);
        $end = Carbon::parse($endDate);

        while ($current <= $end) {
            $dayRequests = SupplyRequest::whereDate('created_at', $current)->count();
            $dayDisbursements = SupplyRequest::whereDate('updated_at', $current)
                ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })
                ->count();
                
            $breakdown[$current->format('Y-m-d')] = [
                'requests' => $dayRequests,
                'disbursements' => $dayDisbursements,
                'day_name' => $current->format('l')
            ];
            
            $current->addDay();
        }

        return $breakdown;
    }

    private function getDailyTrend($startDate, $endDate)
    {
        $trend = [];
        $current = Carbon::parse($startDate);
        $end = Carbon::parse($endDate);

        while ($current <= $end) {
            $trend[$current->format('Y-m-d')] = SupplyRequest::whereDate('created_at', $current)->count();
            $current->addDay();
        }

        return $trend;
    }

    private function getMonthlyWeeklyBreakdown($startDate, $endDate)
    {
        $breakdown = [];
        $current = Carbon::parse($startDate);
        $weekNumber = 1;

        while ($current <= $endDate) {
            $weekStart = $current->copy()->startOfWeek();
            $weekEnd = $current->copy()->endOfWeek();
            
            if ($weekEnd > $endDate) {
                $weekEnd = $endDate;
            }

            $weekRequests = SupplyRequest::whereBetween('created_at', [$weekStart, $weekEnd])->count();
            
            $breakdown['Week ' . $weekNumber] = [
                'requests' => $weekRequests,
                'start' => $weekStart->format('M d'),
                'end' => $weekEnd->format('M d')
            ];

            $current = $weekEnd->copy()->addDay();
            $weekNumber++;
        }

        return $breakdown;
    }

    private function getQuarterlyMonthlyBreakdown($startDate, $endDate)
    {
        $breakdown = [];
        $current = Carbon::parse($startDate);
        $end = Carbon::parse($endDate);

        while ($current <= $end) {
            $monthRequests = SupplyRequest::whereYear('created_at', $current->year)
                ->whereMonth('created_at', $current->month)
                ->count();
            
            $monthDisbursements = SupplyRequest::whereYear('updated_at', $current->year)
                ->whereMonth('updated_at', $current->month)
                ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })
                ->count();
                
            $breakdown[$current->format('M Y')] = [
                'requests' => $monthRequests,
                'disbursements' => $monthDisbursements,
            ];
            
            $current->addMonth();
        }

        return $breakdown;
    }

    private function getAnnualQuarterlyBreakdown($year)
    {
        $breakdown = [];
        for ($quarter = 1; $quarter <= 4; $quarter++) {
            $quarterStart = Carbon::createFromDate($year, ($quarter - 1) * 3 + 1, 1)->startOfQuarter();
            $quarterEnd = Carbon::createFromDate($year, ($quarter - 1) * 3 + 1, 1)->endOfQuarter();
            
            $breakdown['Q' . $quarter . ' ' . $year] = [
                'requests' => SupplyRequest::whereBetween('created_at', [$quarterStart, $quarterEnd])->count(),
                'disbursements' => SupplyRequest::whereBetween('updated_at', [$quarterStart, $quarterEnd])
                    ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count()
            ];
        }
        
        return $breakdown;
    }

    private function getAnnualMonthlyBreakdown($year)
    {
        $breakdown = [];
        for ($month = 1; $month <= 12; $month++) {
            $monthStart = Carbon::createFromDate($year, $month, 1)->startOfMonth();
            $monthEnd = Carbon::createFromDate($year, $month, 1)->endOfMonth();
            
            $breakdown[Carbon::createFromDate($year, $month, 1)->format('M')] = [
                'requests' => SupplyRequest::whereBetween('created_at', [$monthStart, $monthEnd])->count(),
                'disbursements' => SupplyRequest::whereBetween('updated_at', [$monthStart, $monthEnd])
                    ->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count()
            ];
        }
        
        return $breakdown;
    }

    private function getTopDepartments($year)
    {
        $startDate = Carbon::createFromDate($year, 1, 1)->startOfYear();
        $endDate = Carbon::createFromDate($year, 12, 31)->endOfYear();
        
        return SupplyRequest::whereBetween('created_at', [$startDate, $endDate])
            ->groupBy('department')
            ->selectRaw('department, count(*) as request_count')
            ->orderBy('request_count', 'desc')
            ->take(10)
            ->get();
    }

    private function getInventoryGrowth($year)
    {
        $startDate = Carbon::createFromDate($year, 1, 1)->startOfYear();
        $endDate = Carbon::createFromDate($year, 12, 31)->endOfYear();
        
        return [
            'items_added' => Item::whereBetween('created_at', [$startDate, $endDate])->count(),
            'value_added' => Item::whereBetween('created_at', [$startDate, $endDate])->sum('total_value'),
            'categories_added' => Category::whereBetween('created_at', [$startDate, $endDate])->count(),
        ];
    }

    private function getAnnualFinancialSummary($year)
    {
        $startDate = Carbon::createFromDate($year, 1, 1)->startOfYear();
        $endDate = Carbon::createFromDate($year, 12, 31)->endOfYear();
        
        $requests = SupplyRequest::with('item')
            ->whereBetween('created_at', [$startDate, $endDate])
            ->get();
            
        return [
            'total_requested_value' => $requests->sum(function($req) {
                return $req->quantity * 0; // unit_price not available in normalized tables
            }),
            'total_disbursed_value' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })
                ->sum(function($req) {
                    return $req->quantity * 0; // unit_price not available in normalized tables
                }),
            'current_inventory_value' => Item::sum('total_value'),
        ];
    }

    /**
     * AJAX endpoint for dashboard data
     */
    public function dashboardData(Request $request)
    {
        // Check if status column exists
        if (!$this->hasWorkflowColumn()) {
            return response()->json([
                'period' => 'Daily',
                'current_date' => Carbon::now()->format('F j, Y'),
                'chart_data' => [],
                'summary' => [
                    'total_requests' => 0,
                    'fulfilled_requests' => 0,
                    'pending_requests' => 0,
                    'total_value' => 0,
                ],
                'records' => [],
                'message' => 'Dashboard data temporarily unavailable while database is being updated.'
            ]);
        }

        $period = $request->get('period', 'daily');
        $data = $this->getReportData($period);
        
        // Add QR scan statistics to dashboard data
        $scanStats = \App\Models\ItemScanLog::getScanStats();
        $data['qr_scan_stats'] = [
            'total_scans_today' => \App\Models\ItemScanLog::whereDate('scanned_at', Carbon::today())->count(),
            'total_scans' => $scanStats['total_scans'],
            'unique_items_scanned' => $scanStats['unique_items_scanned'],
            'unscanned_items_30_days' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
        ];
        
        return response()->json($data);
    }

    /**
     * Export daily report as CSV
     */
    public function dailyCsv(Request $request)
    {
        $date = $request->get('date', Carbon::today()->toDateString());
        $data = $this->getDailyReportData(Carbon::parse($date));

        $filename = 'daily-report-' . $date . '.csv';
        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => 'attachment; filename="' . $filename . '"',
        ];

        $callback = function() use ($data) {
            $file = fopen('php://output', 'w');

            // CSV headers
            fputcsv($file, ['Date', 'Requests', 'Fulfilled', 'Pending', 'Total Value']);

            // Chart data
            foreach ($data['chart_data'] as $row) {
                fputcsv($file, [
                    $row['date'],
                    $row['requests'],
                    $row['disbursements'],
                    $data['summary']['pending_requests'] ?? 0,
                    number_format($row['value'], 2)
                ]);
            }

            // Summary row
            fputcsv($file, []);
            fputcsv($file, ['Summary', '', '', '', '']);
            fputcsv($file, ['Total Requests', $data['summary']['total_requests'], '', '', '']);
            fputcsv($file, ['Fulfilled Requests', $data['summary']['fulfilled_requests'], '', '', '']);
            fputcsv($file, ['Pending Requests', $data['summary']['pending_requests'], '', '', '']);
            fputcsv($file, ['Total Value', '', '', '', number_format($data['summary']['total_value'], 2)]);

            fclose($file);
        };

        return response()->stream($callback, 200, $headers);
    }

    /**
     * Export weekly report as CSV
     */
    public function weeklyCsv(Request $request)
    {
        $date = $request->get('date', Carbon::now()->toDateString());
        $data = $this->getWeeklyReportData(Carbon::parse($date));

        $filename = 'weekly-report-' . Carbon::parse($date)->startOfWeek()->format('Y-m-d') . '-to-' . Carbon::parse($date)->endOfWeek()->format('Y-m-d') . '.csv';
        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => 'attachment; filename="' . $filename . '"',
        ];

        $callback = function() use ($data) {
            $file = fopen('php://output', 'w');

            // CSV headers
            fputcsv($file, ['Week', 'Requests', 'Fulfilled', 'Pending', 'Total Value']);

            // Chart data
            foreach ($data['chart_data'] as $row) {
                fputcsv($file, [
                    $row['date'],
                    $row['requests'],
                    $row['disbursements'],
                    $data['summary']['pending_requests'] ?? 0,
                    number_format($row['value'], 2)
                ]);
            }

            // Summary row
            fputcsv($file, []);
            fputcsv($file, ['Summary', '', '', '', '']);
            fputcsv($file, ['Total Requests', $data['summary']['total_requests'], '', '', '']);
            fputcsv($file, ['Fulfilled Requests', $data['summary']['fulfilled_requests'], '', '', '']);
            fputcsv($file, ['Pending Requests', $data['summary']['pending_requests'], '', '', '']);
            fputcsv($file, ['Total Value', '', '', '', number_format($data['summary']['total_value'], 2)]);

            fclose($file);
        };

        return response()->stream($callback, 200, $headers);
    }

    /**
     * Export annual report as CSV
     */
    public function annualCsv(Request $request)
    {
        $year = $request->get('year', Carbon::now()->year);
        $data = $this->getAnnualReportData(Carbon::createFromDate($year, 1, 1));

        $filename = 'annual-report-' . $year . '.csv';
        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => 'attachment; filename="' . $filename . '"',
        ];

        $callback = function() use ($data, $year) {
            $file = fopen('php://output', 'w');

            // CSV headers
            fputcsv($file, ['Year', 'Requests', 'Fulfilled', 'Pending', 'Total Value']);

            // Chart data
            foreach ($data['chart_data'] as $row) {
                fputcsv($file, [
                    $row['date'],
                    $row['requests'],
                    $row['disbursements'],
                    $data['summary']['pending_requests'] ?? 0,
                    number_format($row['value'], 2)
                ]);
            }

            // Summary row
            fputcsv($file, []);
            fputcsv($file, ['Summary', '', '', '', '']);
            fputcsv($file, ['Total Requests', $data['summary']['total_requests'], '', '', '']);
            fputcsv($file, ['Fulfilled Requests', $data['summary']['fulfilled_requests'], '', '', '']);
            fputcsv($file, ['Pending Requests', $data['summary']['pending_requests'], '', '', '']);
            fputcsv($file, ['Total Value', '', '', '', number_format($data['summary']['total_value'], 2)]);

            fclose($file);
        };

        return response()->stream($callback, 200, $headers);
    }

    /**
     * Get QR scan report data based on period
     */
    private function getQrScanReportData($period)
    {
        $now = Carbon::now();

        switch ($period) {
            case 'daily':
                return $this->getQrScanDailyReportData($now);
            case 'weekly':
                return $this->getQrScanWeeklyReportData($now);
            case 'monthly':
                return $this->getQrScanMonthlyReportData($now);
            case 'quarterly':
                return $this->getQrScanQuarterlyReportData($now);
            case 'annually':
                return $this->getQrScanAnnualReportData($now);
            default:
                return $this->getQrScanMonthlyReportData($now);
        }
    }

    private function getQrScanDailyReportData($date)
    {
        $startDate = $date->copy()->startOfDay();
        $endDate = $date->copy()->endOfDay();

        // Get last 7 days for chart - use single query with date grouping
        $chartData = [];

        // Get all scans for the last 7 days in one query
        $scansQuery = \App\Models\ItemScanLog::selectRaw('DATE(scanned_at) as date, COUNT(*) as total_scans')
            ->whereBetween('scanned_at', [$date->copy()->subDays(6)->startOfDay(), $endDate])
            ->groupByRaw('DATE(scanned_at)')
            ->orderByRaw('DATE(scanned_at)');

        $scansData = $scansQuery->get()->keyBy('date');

        // Build chart data for last 7 days
        for ($i = 6; $i >= 0; $i--) {
            $checkDate = $date->copy()->subDays($i);
            $dateKey = $checkDate->format('Y-m-d');

            $data = $scansData->get($dateKey);

            $chartData[] = [
                'date' => $checkDate->format('M j'),
                'scans' => $data ? (int)$data->total_scans : 0,
            ];
        }

        // Today's data - get all records for display
        $todayScans = \App\Models\ItemScanLog::with(['item', 'user'])
            ->whereBetween('scanned_at', [$startDate, $endDate])
            ->orderBy('scanned_at', 'desc')
            ->get();

        // Get scan statistics for today
        $scanStats = \App\Models\ItemScanLog::getScanStats($startDate->toDateString(), $endDate->toDateString());

        return [
            'period' => 'Daily',
            'current_date' => $date->format('F j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_scans' => $scanStats['total_scans'],
                'unique_items_scanned' => $scanStats['unique_items_scanned'],
                'unique_users_scanning' => $scanStats['unique_users_scanning'],
                'unscanned_items' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
            ],
            'analytics' => [
                'scans_by_scanner_type' => $scanStats['scans_by_scanner_type'],
                'most_scanned_items' => $scanStats['most_scanned_items'],
                'scans_by_location' => $scanStats['scans_by_location'],
                'daily_scan_trend' => $this->getDailyScanTrend($startDate->toDateString(), $endDate->toDateString()),
                'scan_frequency_analysis' => $this->getOverallScanFrequency(),
                'scan_alerts' => \App\Models\ItemScanLog::getScanAlerts(),
            ],
            'records' => $todayScans
        ];
    }

    private function getQrScanWeeklyReportData($date)
    {
        $startDate = $date->copy()->startOfWeek();
        $endDate = $date->copy()->endOfWeek();

        // Get all scans for the last 8 weeks in one query
        $scansQuery = \App\Models\ItemScanLog::selectRaw('DATE(scanned_at) as date, COUNT(*) as total_scans')
            ->whereBetween('scanned_at', [$date->copy()->subWeeks(7)->startOfWeek(), $endDate])
            ->groupByRaw('DATE(scanned_at)')
            ->orderByRaw('DATE(scanned_at)');

        $scansData = $scansQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y-W') . sprintf('%02d', $date->weekOfYear);
        });

        // Build chart data for last 8 weeks
        $chartData = [];
        for ($i = 7; $i >= 0; $i--) {
            $weekStart = $date->copy()->subWeeks($i)->startOfWeek();
            $weekKey = $weekStart->format('Y-W') . sprintf('%02d', $weekStart->weekOfYear);

            $weekData = $scansData->get($weekKey, collect());
            $totalScans = $weekData->sum('total_scans');

            $chartData[] = [
                'date' => $weekStart->format('M j') . ' - ' . $weekStart->copy()->endOfWeek()->format('M j'),
                'scans' => (int)$totalScans,
            ];
        }

        // Current week scans for display
        $weekScans = \App\Models\ItemScanLog::with(['item', 'user'])
            ->whereBetween('scanned_at', [$startDate, $endDate])
            ->orderBy('scanned_at', 'desc')
            ->get();

        // Get scan statistics for current week
        $scanStats = \App\Models\ItemScanLog::getScanStats($startDate->toDateString(), $endDate->toDateString());

        return [
            'period' => 'Weekly',
            'current_date' => $startDate->format('M j') . ' - ' . $endDate->format('M j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_scans' => $scanStats['total_scans'],
                'unique_items_scanned' => $scanStats['unique_items_scanned'],
                'unique_users_scanning' => $scanStats['unique_users_scanning'],
                'unscanned_items' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
            ],
            'analytics' => [
                'scans_by_scanner_type' => $scanStats['scans_by_scanner_type'],
                'most_scanned_items' => $scanStats['most_scanned_items'],
                'scans_by_location' => $scanStats['scans_by_location'],
                'daily_scan_trend' => $this->getDailyScanTrend($startDate->toDateString(), $endDate->toDateString()),
                'scan_frequency_analysis' => $this->getOverallScanFrequency(),
                'scan_alerts' => \App\Models\ItemScanLog::getScanAlerts(),
            ],
            'records' => $weekScans
        ];
    }

    private function getQrScanAnnualReportData($date)
    {
        $startDate = $date->copy()->startOfYear();
        $endDate = $date->copy()->endOfYear();

        // Get all scans for the last 5 years in one query
        $scansQuery = \App\Models\ItemScanLog::selectRaw('YEAR(scanned_at) as year, COUNT(*) as total_scans')
            ->whereBetween('scanned_at', [$date->copy()->subYears(4)->startOfYear(), $endDate])
            ->groupByRaw('YEAR(scanned_at)')
            ->orderByRaw('YEAR(scanned_at)');

        $scansData = $scansQuery->get()->keyBy('year');

        // Build chart data for last 5 years
        $chartData = [];
        for ($i = 4; $i >= 0; $i--) {
            $year = $date->copy()->subYears($i)->year;

            $data = $scansData->get($year);

            $chartData[] = [
                'date' => (string)$year,
                'scans' => $data ? (int)$data->total_scans : 0,
            ];
        }

        // Current year scans for display
        $yearScans = \App\Models\ItemScanLog::with(['item', 'user'])
            ->whereBetween('scanned_at', [$startDate, $endDate])
            ->orderBy('scanned_at', 'desc')
            ->get();

        // Get scan statistics for current year
        $scanStats = \App\Models\ItemScanLog::getScanStats($startDate->toDateString(), $endDate->toDateString());

        return [
            'period' => 'Annual',
            'current_date' => (string)$date->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_scans' => $scanStats['total_scans'],
                'unique_items_scanned' => $scanStats['unique_items_scanned'],
                'unique_users_scanning' => $scanStats['unique_users_scanning'],
                'unscanned_items' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
            ],
            'analytics' => [
                'scans_by_scanner_type' => $scanStats['scans_by_scanner_type'],
                'most_scanned_items' => $scanStats['most_scanned_items'],
                'scans_by_location' => $scanStats['scans_by_location'],
                'daily_scan_trend' => $this->getDailyScanTrend($startDate->toDateString(), $endDate->toDateString()),
                'scan_frequency_analysis' => $this->getOverallScanFrequency(),
                'scan_alerts' => \App\Models\ItemScanLog::getScanAlerts(),
            ],
            'records' => $yearScans
        ];
    }

    private function getQrScanMonthlyReportData($date)
    {
        $startDate = $date->copy()->startOfMonth();
        $endDate = $date->copy()->endOfMonth();

        // Get all scans for the last 12 months in one query
        $scansQuery = \App\Models\ItemScanLog::selectRaw('DATE(scanned_at) as date, COUNT(*) as total_scans')
            ->whereBetween('scanned_at', [$date->copy()->subMonths(11)->startOfMonth(), $endDate])
            ->groupByRaw('DATE(scanned_at)')
            ->orderByRaw('DATE(scanned_at)');

        $scansData = $scansQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y-m');
        });

        // Build chart data for last 12 months
        $chartData = [];
        for ($i = 11; $i >= 0; $i--) {
            $monthStart = $date->copy()->subMonths($i)->startOfMonth();
            $monthKey = $monthStart->format('Y-m');

            $monthData = $scansData->get($monthKey, collect());
            $totalScans = $monthData->sum('total_scans');

            $chartData[] = [
                'date' => $monthStart->format('M Y'),
                'scans' => (int)$totalScans,
            ];
        }

        // Current month scans for display
        $monthScans = \App\Models\ItemScanLog::with(['item', 'user'])
            ->whereBetween('scanned_at', [$startDate, $endDate])
            ->orderBy('scanned_at', 'desc')
            ->get();

        // Get scan statistics for current month
        $scanStats = \App\Models\ItemScanLog::getScanStats($startDate->toDateString(), $endDate->toDateString());

        return [
            'period' => 'Monthly',
            'current_date' => $startDate->format('F Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_scans' => $scanStats['total_scans'],
                'unique_items_scanned' => $scanStats['unique_items_scanned'],
                'unique_users_scanning' => $scanStats['unique_users_scanning'],
                'unscanned_items' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
            ],
            'analytics' => [
                'scans_by_scanner_type' => $scanStats['scans_by_scanner_type'],
                'most_scanned_items' => $scanStats['most_scanned_items'],
                'scans_by_location' => $scanStats['scans_by_location'],
                'daily_scan_trend' => $this->getDailyScanTrend($startDate->toDateString(), $endDate->toDateString()),
                'scan_frequency_analysis' => $this->getOverallScanFrequency(),
                'scan_alerts' => \App\Models\ItemScanLog::getScanAlerts(),
            ],
            'records' => $monthScans
        ];
    }

    private function getQrScanQuarterlyReportData($date)
    {
        $startDate = $date->copy()->startOfQuarter();
        $endDate = $date->copy()->endOfQuarter();

        // Get all scans for the last 4 quarters in one query
        $scansQuery = \App\Models\ItemScanLog::selectRaw('DATE(scanned_at) as date, COUNT(*) as total_scans')
            ->whereBetween('scanned_at', [$date->copy()->subQuarters(3)->startOfQuarter(), $endDate])
            ->groupByRaw('DATE(scanned_at)')
            ->orderByRaw('DATE(scanned_at)');

        $scansData = $scansQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y') . '-Q' . $date->quarter;
        });

        // Build chart data for last 4 quarters
        $chartData = [];
        for ($i = 3; $i >= 0; $i--) {
            $quarterStart = $date->copy()->subQuarters($i)->startOfQuarter();
            $quarterKey = $quarterStart->format('Y') . '-Q' . $quarterStart->quarter;

            $quarterData = $scansData->get($quarterKey, collect());
            $totalScans = $quarterData->sum('total_scans');

            $chartData[] = [
                'date' => 'Q' . $quarterStart->quarter . ' ' . $quarterStart->year,
                'scans' => (int)$totalScans,
            ];
        }

        // Current quarter scans for display
        $quarterScans = \App\Models\ItemScanLog::with(['item', 'user'])
            ->whereBetween('scanned_at', [$startDate, $endDate])
            ->orderBy('scanned_at', 'desc')
            ->get();

        // Get scan statistics for current quarter
        $scanStats = \App\Models\ItemScanLog::getScanStats($startDate->toDateString(), $endDate->toDateString());

        return [
            'period' => 'Quarterly',
            'current_date' => 'Q' . $startDate->quarter . ' ' . $startDate->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_scans' => $scanStats['total_scans'],
                'unique_items_scanned' => $scanStats['unique_items_scanned'],
                'unique_users_scanning' => $scanStats['unique_users_scanning'],
                'unscanned_items' => \App\Models\ItemScanLog::getUnscannedItems(30)->count(),
            ],
            'analytics' => [
                'scans_by_scanner_type' => $scanStats['scans_by_scanner_type'],
                'most_scanned_items' => $scanStats['most_scanned_items'],
                'scans_by_location' => $scanStats['scans_by_location'],
                'daily_scan_trend' => $this->getDailyScanTrend($startDate->toDateString(), $endDate->toDateString()),
                'scan_frequency_analysis' => $this->getOverallScanFrequency(),
                'scan_alerts' => \App\Models\ItemScanLog::getScanAlerts(),
            ],
            'records' => $quarterScans
        ];
    }

    /**
     * Get daily scan trend for QR analytics
     */
    private function getDailyScanTrend($dateFrom, $dateTo)
    {
        return \App\Models\ItemScanLog::whereBetween('scanned_at', [$dateFrom, $dateTo])
            ->selectRaw('DATE(scanned_at) as date, COUNT(*) as scan_count')
            ->groupBy('date')
            ->orderBy('date')
            ->pluck('scan_count', 'date');
    }

    /**
     * Get overall scan frequency analysis
     */
    private function getOverallScanFrequency()
    {
        $allItems = Item::all();
        $frequencyData = [];

        foreach ($allItems as $item) {
            $analysis = \App\Models\ItemScanLog::getScanFrequencyAnalysis($item->id);
            if ($analysis && $analysis['total_scans'] > 0) {
                $frequencyData[] = [
                    'item' => $item,
                    'analysis' => $analysis
                ];
            }
        }

        // Sort by average days between scans (items scanned less frequently first)
        usort($frequencyData, function($a, $b) {
            return $b['analysis']['average_days_between_scans'] <=> $a['analysis']['average_days_between_scans'];
        });

        return array_slice($frequencyData, 0, 20); // Top 20 items by scan frequency
    }

    /**
     * Get date range based on period
     */
    private function getDateRangeFromPeriod($period)
    {
        $now = Carbon::now();

        switch ($period) {
            case 'daily':
                return [
                    'from' => $now->copy()->startOfDay()->toDateString(),
                    'to' => $now->copy()->endOfDay()->toDateString()
                ];
            case 'weekly':
                return [
                    'from' => $now->copy()->startOfWeek()->toDateString(),
                    'to' => $now->copy()->endOfWeek()->toDateString()
                ];
            case 'monthly':
                return [
                    'from' => $now->copy()->startOfMonth()->toDateString(),
                    'to' => $now->copy()->endOfMonth()->toDateString()
                ];
            case 'quarterly':
                return [
                    'from' => $now->copy()->startOfQuarter()->toDateString(),
                    'to' => $now->copy()->endOfQuarter()->toDateString()
                ];
            case 'annually':
                return [
                    'from' => $now->copy()->startOfYear()->toDateString(),
                    'to' => $now->copy()->endOfYear()->toDateString()
                ];
            default:
                return [
                    'from' => $now->copy()->startOfMonth()->toDateString(),
                    'to' => $now->copy()->endOfMonth()->toDateString()
                ];
        }
    }

    /**
     * Get request analytics report data based on period
     */
    private function getRequestAnalyticsReportData($period)
    {
        $now = Carbon::now();

        switch ($period) {
            case 'daily':
                return $this->getRequestAnalyticsDailyReportData($now);
            case 'weekly':
                return $this->getRequestAnalyticsWeeklyReportData($now);
            case 'monthly':
                return $this->getRequestAnalyticsMonthlyReportData($now);
            case 'quarterly':
                return $this->getRequestAnalyticsQuarterlyReportData($now);
            case 'annually':
                return $this->getRequestAnalyticsAnnualReportData($now);
            default:
                return $this->getRequestAnalyticsMonthlyReportData($now);
        }
    }

    private function getRequestAnalyticsDailyReportData($date)
    {
        $startDate = $date->copy()->startOfDay();
        $endDate = $date->copy()->endOfDay();

        // Get last 7 days for chart - use single query with date grouping
        $chartData = [];

        // Get all requests for the last 7 days in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(created_at) as date, COUNT(*) as total_requests')
            ->whereBetween('created_at', [$date->copy()->subDays(6)->startOfDay(), $endDate])
            ->groupByRaw('DATE(created_at)')
            ->orderByRaw('DATE(created_at)');

        $requestsData = $requestsQuery->get()->keyBy('date');

        // Build chart data for last 7 days
        for ($i = 6; $i >= 0; $i--) {
            $checkDate = $date->copy()->subDays($i);
            $dateKey = $checkDate->format('Y-m-d');

            $data = $requestsData->get($dateKey);

            $chartData[] = [
                'date' => $checkDate->format('M j'),
                'requests' => $data ? (int)$data->total_requests : 0,
            ];
        }

        // Today's data - get all records for display
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        // Analytics calculations
        $analytics = [
            'total_requests' => $requests->count(),
            'approved_requests' => $requests->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_requests' => $requests->where('status', 'pending')->count(),
            'declined_requests' => $requests->where('status', 'declined')->count(),
            'fulfilled_requests' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
            'average_processing_time' => $this->calculateAverageProcessingTime($requests),
            'most_requested_items' => $this->getMostRequestedItems($requests),
            'requests_by_department' => $this->getRequestsByDepartment($requests),
            'requests_by_priority' => $this->getRequestsByPriority($requests),
            'monthly_trend' => $this->getMonthlyTrend($startDate->toDateString(), $endDate->toDateString()),
        ];

        $departments = SupplyRequest::distinct()->pluck('department')->filter();

        return [
            'period' => 'Daily',
            'current_date' => $date->format('F j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $analytics['total_requests'],
                'approved_requests' => $analytics['approved_requests'],
                'pending_requests' => $analytics['pending_requests'],
                'declined_requests' => $analytics['declined_requests'],
            ],
            'analytics' => $analytics,
            'departments' => $departments,
            'records' => $requests
        ];
    }

    private function getRequestAnalyticsWeeklyReportData($date)
    {
        $startDate = $date->copy()->startOfWeek();
        $endDate = $date->copy()->endOfWeek();

        // Get all requests for the last 8 weeks in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(created_at) as date, COUNT(*) as total_requests')
            ->whereBetween('created_at', [$date->copy()->subWeeks(7)->startOfWeek(), $endDate])
            ->groupByRaw('DATE(created_at)')
            ->orderByRaw('DATE(created_at)');

        $requestsData = $requestsQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y-W') . sprintf('%02d', $date->weekOfYear);
        });

        // Build chart data for last 8 weeks
        $chartData = [];
        for ($i = 7; $i >= 0; $i--) {
            $weekStart = $date->copy()->subWeeks($i)->startOfWeek();
            $weekKey = $weekStart->format('Y-W') . sprintf('%02d', $weekStart->weekOfYear);

            $weekData = $requestsData->get($weekKey, collect());
            $totalRequests = $weekData->sum('total_requests');

            $chartData[] = [
                'date' => $weekStart->format('M j') . ' - ' . $weekStart->copy()->endOfWeek()->format('M j'),
                'requests' => (int)$totalRequests,
            ];
        }

        // Current week requests for display
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        // Analytics calculations
        $analytics = [
            'total_requests' => $requests->count(),
            'approved_requests' => $requests->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_requests' => $requests->where('status', 'pending')->count(),
            'declined_requests' => $requests->where('status', 'declined')->count(),
            'fulfilled_requests' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
            'average_processing_time' => $this->calculateAverageProcessingTime($requests),
            'most_requested_items' => $this->getMostRequestedItems($requests),
            'requests_by_department' => $this->getRequestsByDepartment($requests),
            'requests_by_priority' => $this->getRequestsByPriority($requests),
            'monthly_trend' => $this->getMonthlyTrend($startDate->toDateString(), $endDate->toDateString()),
        ];

        $departments = SupplyRequest::distinct()->pluck('department')->filter();

        return [
            'period' => 'Weekly',
            'current_date' => $startDate->format('M j') . ' - ' . $endDate->format('M j, Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $analytics['total_requests'],
                'approved_requests' => $analytics['approved_requests'],
                'pending_requests' => $analytics['pending_requests'],
                'declined_requests' => $analytics['declined_requests'],
            ],
            'analytics' => $analytics,
            'departments' => $departments,
            'records' => $requests
        ];
    }

    private function getRequestAnalyticsAnnualReportData($date)
    {
        $startDate = $date->copy()->startOfYear();
        $endDate = $date->copy()->endOfYear();

        // Get all requests for the last 5 years in one query
        $requestsQuery = SupplyRequest::selectRaw('YEAR(created_at) as year, COUNT(*) as total_requests')
            ->whereBetween('created_at', [$date->copy()->subYears(4)->startOfYear(), $endDate])
            ->groupByRaw('YEAR(created_at)')
            ->orderByRaw('YEAR(created_at)');

        $requestsData = $requestsQuery->get()->keyBy('year');

        // Build chart data for last 5 years
        $chartData = [];
        for ($i = 4; $i >= 0; $i--) {
            $year = $date->copy()->subYears($i)->year;

            $data = $requestsData->get($year);

            $chartData[] = [
                'date' => (string)$year,
                'requests' => $data ? (int)$data->total_requests : 0,
            ];
        }

        // Current year requests for display
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        // Analytics calculations
        $analytics = [
            'total_requests' => $requests->count(),
            'approved_requests' => $requests->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_requests' => $requests->where('status', 'pending')->count(),
            'declined_requests' => $requests->where('status', 'declined')->count(),
            'fulfilled_requests' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
            'average_processing_time' => $this->calculateAverageProcessingTime($requests),
            'most_requested_items' => $this->getMostRequestedItems($requests),
            'requests_by_department' => $this->getRequestsByDepartment($requests),
            'requests_by_priority' => $this->getRequestsByPriority($requests),
            'monthly_trend' => $this->getMonthlyTrend($startDate->toDateString(), $endDate->toDateString()),
        ];

        $departments = SupplyRequest::distinct()->pluck('department')->filter();

        return [
            'period' => 'Annual',
            'current_date' => (string)$date->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $analytics['total_requests'],
                'approved_requests' => $analytics['approved_requests'],
                'pending_requests' => $analytics['pending_requests'],
                'declined_requests' => $analytics['declined_requests'],
            ],
            'analytics' => $analytics,
            'departments' => $departments,
            'records' => $requests
        ];
    }

    private function getRequestAnalyticsMonthlyReportData($date)
    {
        $startDate = $date->copy()->startOfMonth();
        $endDate = $date->copy()->endOfMonth();

        // Get all requests for the last 12 months in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(created_at) as date, COUNT(*) as total_requests')
            ->whereBetween('created_at', [$date->copy()->subMonths(11)->startOfMonth(), $endDate])
            ->groupByRaw('DATE(created_at)')
            ->orderByRaw('DATE(created_at)');

        $requestsData = $requestsQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y-m');
        });

        // Build chart data for last 12 months
        $chartData = [];
        for ($i = 11; $i >= 0; $i--) {
            $monthStart = $date->copy()->subMonths($i)->startOfMonth();
            $monthKey = $monthStart->format('Y-m');

            $monthData = $requestsData->get($monthKey, collect());
            $totalRequests = $monthData->sum('total_requests');

            $chartData[] = [
                'date' => $monthStart->format('M Y'),
                'requests' => (int)$totalRequests,
            ];
        }

        // Current month requests for display
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        // Analytics calculations
        $analytics = [
            'total_requests' => $requests->count(),
            'approved_requests' => $requests->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_requests' => $requests->where('status', 'pending')->count(),
            'declined_requests' => $requests->where('status', 'declined')->count(),
            'fulfilled_requests' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
            'average_processing_time' => $this->calculateAverageProcessingTime($requests),
            'most_requested_items' => $this->getMostRequestedItems($requests),
            'requests_by_department' => $this->getRequestsByDepartment($requests),
            'requests_by_priority' => $this->getRequestsByPriority($requests),
            'monthly_trend' => $this->getMonthlyTrend($startDate->toDateString(), $endDate->toDateString()),
        ];

        $departments = SupplyRequest::distinct()->pluck('department')->filter();

        return [
            'period' => 'Monthly',
            'current_date' => $startDate->format('F Y'),
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $analytics['total_requests'],
                'approved_requests' => $analytics['approved_requests'],
                'pending_requests' => $analytics['pending_requests'],
                'declined_requests' => $analytics['declined_requests'],
            ],
            'analytics' => $analytics,
            'departments' => $departments,
            'records' => $requests
        ];
    }

    private function getRequestAnalyticsQuarterlyReportData($date)
    {
        $startDate = $date->copy()->startOfQuarter();
        $endDate = $date->copy()->endOfQuarter();

        // Get all requests for the last 4 quarters in one query
        $requestsQuery = SupplyRequest::selectRaw('DATE(created_at) as date, COUNT(*) as total_requests')
            ->whereBetween('created_at', [$date->copy()->subQuarters(3)->startOfQuarter(), $endDate])
            ->groupByRaw('DATE(created_at)')
            ->orderByRaw('DATE(created_at)');

        $requestsData = $requestsQuery->get()->groupBy(function($item) {
            $date = Carbon::parse($item->date);
            return $date->format('Y') . '-Q' . $date->quarter;
        });

        // Build chart data for last 4 quarters
        $chartData = [];
        for ($i = 3; $i >= 0; $i--) {
            $quarterStart = $date->copy()->subQuarters($i)->startOfQuarter();
            $quarterKey = $quarterStart->format('Y') . '-Q' . $quarterStart->quarter;

            $quarterData = $requestsData->get($quarterKey, collect());
            $totalRequests = $quarterData->sum('total_requests');

            $chartData[] = [
                'date' => 'Q' . $quarterStart->quarter . ' ' . $quarterStart->year,
                'requests' => (int)$totalRequests,
            ];
        }

        // Current quarter requests for display
        $requests = SupplyRequest::with(['user', 'item', 'item.category'])
            ->whereBetween('created_at', [$startDate, $endDate])
            ->orderBy('created_at', 'desc')
            ->get();

        // Analytics calculations
        $analytics = [
            'total_requests' => $requests->count(),
            'approved_requests' => $requests->whereIn('status', ['approved_by_admin', 'fulfilled', 'claimed'])->count(),
            'pending_requests' => $requests->where('status', 'pending')->count(),
            'declined_requests' => $requests->where('status', 'declined')->count(),
            'fulfilled_requests' => $requests->where(function($q) { return $this->getRequestsByStatus($q, 'fulfilled'); })->count(),
            'average_processing_time' => $this->calculateAverageProcessingTime($requests),
            'most_requested_items' => $this->getMostRequestedItems($requests),
            'requests_by_department' => $this->getRequestsByDepartment($requests),
            'requests_by_priority' => $this->getRequestsByPriority($requests),
            'monthly_trend' => $this->getMonthlyTrend($startDate->toDateString(), $endDate->toDateString()),
        ];

        $departments = SupplyRequest::distinct()->pluck('department')->filter();

        return [
            'period' => 'Quarterly',
            'current_date' => 'Q' . $startDate->quarter . ' ' . $startDate->year,
            'chart_data' => $chartData,
            'summary' => [
                'total_requests' => $analytics['total_requests'],
                'approved_requests' => $analytics['approved_requests'],
                'pending_requests' => $analytics['pending_requests'],
                'declined_requests' => $analytics['declined_requests'],
            ],
            'analytics' => $analytics,
            'departments' => $departments,
            'records' => $requests
        ];
    }
}
